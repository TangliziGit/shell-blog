# 2022 年终总结

> 总结：入门数据库研发的菜鸡一年

# 总览

今年大概做了这些事情：

- 一月：DOP平台里程碑, MIT6.824, CMU15445, 春招
- 二月：CMU15445, 春招
- 三月：春招结束
- 四月：大作业、DOP对接&发布、《C++ Primer》、练习画画、锻炼
- 五月：ospp申请、准备入职、找房搬家
- 六月：在DolphinDB实习
  - 第一周：ranking红黑树优化函数mrank
  - 第二周：编写函数valueChanged
  - 第三周：实现AdaptiveQueue、 分享Linux生产工具
  - 第四周：parallel recovery（持续四周，OLTP方面学到很多）
- 七月：在DolphinDB实习
  - 第一周：parallel recovery
  - 第二周：parallel recovery bug & sql trace
- 八月：在DolphinDB实习做sql trace、秋招提前批、简单的支出计划
- 九月：在DolphinDB实习做sql trace、秋招
- 十月：助教、CMU15213、签三方、OceanBase初赛、ATEC初赛、CompassCI
- 十一月：CompassCI、ob决赛
- 十二月：毕设

# 实验室工作
## DevOps平台
入校时接手了DOP平台的机房落地任务，去年参与服务器配置和采购方面的讨论。最终实验室在年末购买到三台DELL R740（378G 96C）。这机台机器算是我用到的配置最好的机器，时常我也偷摸在上面跑些实验室无关的东西。令人十分舒适😎。
今年到五月份为止，做了很多看起来没什么作用和技术含量的工作：维护内网穿透、透明代理、整合代码到SOFTENG组织、处理一次挖矿攻击、监控负载、处理技术债等。前后也写了10篇左右技术方案、10篇左右双周报告，本质是总结工作和让后来人避坑。
做了半年的结果是能在机器上跑通主要流程，对接了一位同学的工作，整合了一个毕社项目。这个项目现在已经让队友和未来的五代目来接手了。在我看了这个项目的意义更多是整合科研工作，比如各种毕设和论文里的demo项目。DOP本身的流水线目前也只是用来做k8s部署的，所以跟devops的关系不大，DOP这个名字应该也要被换掉吧。
不过这个项目也成功让我获得了不少实验室内的分数，让我能成功申请实习，应该也能让我通过毕业条件。

## CompassCI
实验室和华为合作的项目，目前应该是开题失败的。项目是在6月份开始，我在9月底参与这个工作，一直到11月底都在跟华为方讨论方案。这个过程并没有任何实现工作，因为我们的方案华为方一直在挑毛病。期间我也在忙比赛，对这个项目一直摸不着头脑，只参与了几次会议和架构设计的讨论，做了一些爬虫的工作。实际会议中，双方都不太懂对方在讲什么。而我们私下的讨论里也是非常缺乏信心，对方从来就没有肯定过方案，所以大家都认为这个项目注定会失败。
不过因为我们在这个项目里投入了很多，所以它现在摇身一变成为我们的毕设题目了😥。

## 毕业设计
简单来说我们在做一个自动测试的平台，目标是那些需要很长时间编译、需要真实Linux环境、需要做通用benchmark（如dstat、iostate等）的软件。比如Linux内核、数据库系统等。项目背景比较难说，由华为项目变成实验室DevOps系统（其实就是没有什么背景。具体用例是用户CLI提交或者自动扫描repo来提交测试任务，最后收到测试分析结果（包括日志、由日志分析出的关键数据），如果构建测试通过则依次跑启动、功能、性能测试。
具体实现方法是测试机跑iPXE提供启动任意操作系统，NFS+OverlayFS提供干净的文件系统，lkp-tests提供测试用例。配合调度器做一些优先级调度、结果分析器分析日志并触发下一个任务。
现在是毕设第三周，核心的调度器&测试机实现已经ok。现在担心的是答辩时怎么讲背景和工作量。

# 学习
## MIT6.824 & CMU15445
入门数据库内核的两门课。在春招上对我这种缺乏经验的同学有很大帮助，尤其是6.824的raft实验和445的事务能帮我在面试的时候打出一套组合拳（雾。上了这两门课让我后悔没在大二就学它。

## CMU15213 / CSAPP
又是一门让我后悔没早学的课。最让我受益的是缓冲区溢出攻击、cache、程序优化的部分。ob比赛让我中断了学习，这个课的笔记总结我还没来得及写，计划这个月继续学顺带吧遗留的体系结构的课搞定。

## C++ Primer
这本书没什么可说的，学C++的必备书籍了。它很全面讲到了C++11的各个方面，让我了解到很多有意思的feature，比如左右值、prvalue、模板特化/偏特化。模板元编程也勾起了我学编程最初的好奇&快乐。
学C++主要是我在春招拿到了dolphindb的offer，产品ddb是由C++实现的。（后续工作发现还需要一些汇编知识🥵

# 比赛
## OceanBase数据库竞赛 - 旁路导入
跟两位实习同学一起搞的比赛，分成初赛和决赛。
十月份的初赛是在miniob上实现一些比较业务的基础功能，我参与的是实现select中的函数、聚合函数、groupby、typecast。感觉初赛主要是让不熟悉数据库内核的同学体验实际开发是什么样的。我们分工在两周内拿到了所有分数，最终排名第四。
十一月的决赛有点意思，目标是减少在TPC-H的lineitem表的load data时间，本质是跳过冗长insert流程直接转换CSV存储到SSTable。因为ob底层存储是SSTable，所以导入时需要排序数据。我们讨论了外部排序、桶排序和map-reduce的方案，最后由于时间紧张选择了桶排序。我们写代码比较晚，多线程桶排序提测后我们排名大概是第6的样子，后续做了一系列优化最终排名维持在12名，是刚好能获奖的位置😣。不得不说时间着实紧张，一位队友需要备考，另一位只参与了三周多，而我因为实验室项目只参与了两周。
这里稍微展开一下优化部分的工作。除了常见的并发优化外，做了基数排序、桶文件压缩和异步IO优化。分别减少了12.1%、16.9%、6.5%的耗时。
基数排序主要是对象提出来的😚，观察火焰图能发现排序占用了14.7%时间。后来我们做了一些经验计算发现能把std::sort的时间减少到17.9%左右。后续的实验和得分也证实了这个结果，耗时可以到19.6%。
桶文件压缩是另一位同学的思路。起因是观察dstat发现分桶时出现14%左右的iowait，而且耗时与线程数没有台大关系，所以说瓶颈在io上。对比了zstd和lz4，前者压缩率更高但后者有更快的压缩速度，我们选择了后者。这是力度最大的优化。
异步IO我们没有做好。还是观察dstat，发现仍有周期性iowait，于是希望用native aio做分区的读写。这个东西有很多坑，比如需要对齐512B、仍然会存在cpu idle等。最后由于异步读总是出现返回的字节数和实际的字节数不同的情况，我们放弃了这个想法，转而去做调参了。

## ATEC竞赛 - 优化存储
完全没有参与实现的一次比赛，忙着搞实验室的活，完全充当了某队友的腿部挂件。最后排名第7算是差点拿到奖励。
这次比赛的目标是减少TPC-H的lineitem表存储空间。优化用到了主键的差值编码、组合编码、字符串的哈夫曼编码、索引砍掉了B树直接二分查找、zstd块压缩。队友思路很清晰，实现也是飞快。不过最后我们都没思路了，不知道其他选手是怎么优化的。

# 求职 & 实习
## 春招
准备春招是和实验室项目同时进行的。虽然有点可耻，不过还是说一下如何顶着实验室压力准备面试这件事。诀窍就是一二月份赶实验室的活，目的是在开始复习前要把项目推进到春招结束时期望的样子，同时全过程挤牙膏🫣。这样可以在春招有大把连续的时间。
再说下春招的策略。因为我的实验室背景跟数据库没半毛钱关系，倒是跟云原生比较相关（主要是本科毕设和实验室工作需要用到些k8s），所以打算是两手准备。db方面总结了6.824、15445和基础知识。云原生主要是准备k8s和docker的原理，还有一些项目经历。做了两份不同的简历，db方向发给了5个公司，云原生给了4个，还投了4个外企。包括databend、p社、dolphindb、字节、阿里、华为、网易、亚麻、hulu、MS等。总结来看的话，还不如只准备db，面不熟悉的岗只会给自己带来打击。
先说说面挂的几家。databend面挂是因为我确实没有很理解k8s网络的原理。亚麻做题很顺利不太清楚为什么会挂。阿里业务部门挂掉是因为面经没背好。最后要提一下很有意思的P社，三面主管当时对我展开疯狂的HR式提问，各种刨根问底让我很绝望。不过也很感谢面试官，让我认识到很多自己的问题。
- 学习没有积累：各种项目汇总到简历上其实并没有让我学/深挖到什么，包括实验室的活、实习和开源经历；也没有发现&学习身边优秀的人
- 知识没有串起来：问到raft要能讲出leader从接受命令到内核到网卡再到节点主机的过程，操作系统中断很长时间要如何排查等
- 没有长期规划：如果做数据库，要做什么方面？两年后你想成为什么样的人？
要习惯深挖和总结问题是我学到很有用的一点。发现和学习优秀的人需要我更外向一点，今年的实习已经在尝试中。串连知识点我认为需要更实际的场景/实验，因为我水平不够，架空的知识点本身就会很快忘掉，记笔记也不会想到要翻看。长期规划也让我有点抓瞎，我对职位没有追求，也不清楚要规划什么。薪资当然越高越好，不过也要先尝试自己能涨薪多少才能有数。
总之最终拿到了字节、阿里和ddb的offer。拒掉字节是因为岗位是大数据离线业务方面；拒阿里是因为担心工作不核心、下班晚也怕pua。

## 实习
从6月初到9月底，在DolphinDB做C++数据库内核实习。除了做了一点零散的函数优化和编写外，接手了两个比较大的任务：OLTP并行恢复和SQL Trace。另外在第三周还做了一次Linux效率工具分享。
ddb的OLTP引擎还在很初始的开发阶段，有很多看起来naive的地方。关于OLTP并行恢复，简单讲就是利用事务ID的顺序来处理事务间DML写冲突，用独占或同步的方式执行部分DDL。这个任务涉及到了事务、日志存储、GC、并发方面的内容，确实很有挑战性，收获相当大。debug的过程非常考验细节，最后也给OLTP调了几个bug出来。
SQL Trace是一个用来做性能分析的工具，相比与log和explain，它能成树状的打印从请求到来到回复响应的关键过程。其实本质就是分布式打日志，再收集分析。这个需求居然做了将近两个月，主要原因一部分是修改核心代码需要用传文件的方式、核心代码的debug、降低性能开销、写教程和文档。这个项目的亮点在于支持分布式查询且对接jeager。
在做实习的过程中，OLTP的工作里受到了很多同事认可和赞赏。我自己总是觉得过誉了，因为仔细想想其实我的工作不算难，很多一起来的实习生应该都能做到。所以内心会产生一点不安感，担心是不是要留下我，于是才私下商量好的（有点神经质



## 秋招
实习生小伙伴大概都在7月底开始的秋招。而我是8月中旬才意识到这个问题😣，于是一边打工一边准备秋招。虽然下班早但奈何人太懒，回家就知道看手机，整理好简历就直接投了，没有任何新的学习。于是秋招一路受挫，投了10家数据库内核和存储相关的岗位，最后只受到了三家offer，还有迟到的两家offer call。比较了一番还是留在ddb最好，主要考虑的是wlb、有无客户&营收、技术能力、假期和薪水。
总的说来是最失败的一次招聘。

# 生活 & 爱好
## 板绘
年初（？）在家无聊的时候被老妈讲要培养一个爱好，突然想到从初中以来就想画画，高中更是在作业本后面花了个miku头吓老师一跳。大一曾经认真考虑过画画这条路的，或许还能在做程序员退休后靠这个赚钱🫣。黄光剑本科就不是学绘画的，现在也是很出名的插画师了。或许成为插画师还有年龄、天赋之类的说法，不过作为爱好，接点小单应该是不错的。
Krenz是我觉得很厉害的老师，很早前看过他的透视公开课，能把技巧&绘画路线讲得很有条理。四月份没忍住买了个板子准备跟Krenz幼儿园学板绘。跟了半个多月练习各种画直线和抓型，让我感觉很有进步。不过一次练习耗时很长，在试图降低耗时的过程中，我又要开始实习了。幸苦构建起来的时间安排又被打破了。接下来准备继续开始画画，也要考虑个计策不要中断太久这个爱好。

## 锻炼
该好好锻炼身体了，在南京的一段时间吃饭总是不消化，尝试做蹲起发现有效果。于是开始Keep周期性锻炼，后来也慢慢在玄武湖晨跑。不过这个习惯又被实习给打破了🙄，肚子也变大了体重也涨了。有些时候也想象自己一堆腹肌的样子，对象应该也很开心吧🥰。

总之今年要把锻炼也提上日程。

# 总结 & 反思

今年是比较顺利的一年了，从年初开始一边给实验室打工一边给自己补课，在春招接受了不错的offer，实习里也获得了很好的机会。不过秋招没有好好准备是我的遗憾，一方面是懒惰一方面是学艺不精。于是赶在投入社会毒打前迫切的想要养成好习惯 & 学知识，包括健身、克制自己刷手机、学Linux底层原理、读paper、学C++等。另外在春招遇到了很多厉害且严格的面试官，他们能在短时间发现我的缺点给出建议。这些建议我得好好对待，毕竟很少有机会收到直白深刻的评价。最后，在实习里我应该更多跟同事们来往，总觉得自己在排斥公司的圈子，这不是个好现象。

挑了几个重要的点，希望自己在23年能培养好这些习惯，作为今年的反思：

- 习惯深挖并总结问题，多串联知识点；(当考虑要不要深挖/总结时，就要想到如何面对面试官，怎么说才能体现自己的价值）
- 要善于跟同事来往、发现和学习优秀的人；（记得关注谁做了厉害的事情、找机会学习为什么做如何做）
- 要有长期职业规划；可以问问津铭
- 锻炼要提上日程
