# Docker 实践

> https://docs.docker.com/develop/



## 构建镜像



### 最佳实践

小镜像会拉取更快并且加载至内存更快。

- 选取小的基镜像
- 多阶段构建
  - 合并`RUN`指令
  - 在生产镜像之上，构建以提供测试和除错的阶段（可设定目标阶段）
  - 可使用外部镜像作为阶段
- 添加`tag`，如`prod`和`test`，不要依赖`lastest`
- 使用CI/CD进行测试和部署
- 持久化数据需要使用卷
  - 在开发时可以只使用绑定，使容器可以访问源代码
  - 但在生产时需要使用卷
- 在生产阶段的注意点
  - 使用卷来支持持久化存储
  - 使用用户命名空间提供更好的隔离性
  - 必须使用同一的NTP客户端



**细节**

- 你可以使用Here Documents来构建镜像

  - 注意`COPY`和`ADD`是可用的，仅当使用`-f-`指定当前位置

  ```shell
  docker build -t xxx -f- . <<EOF
  FROM busybox
  COPY somefile.txt .
  RUN cat /somefile.txt
  EOF
  ```

- 使用`.dockerignore`忽略一些文件




### 使用`BuildKit`

> https://docs.docker.com/develop/develop-images/build_enhancements/

针对18.09版本的docker build引入了对构建架构的全面大改。

使用 BuildKit 会看到性能，存储管理，功能和安全性方面的改进。

- 新的CLI输出
- `secret`信息
- 使用`ssh`接入私有数据



