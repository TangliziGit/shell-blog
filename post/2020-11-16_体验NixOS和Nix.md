# NixOS

11月15号这天，完成了Fabric的文档学习。
闲来无事，于是尝试向往已久的NixOS，尝试一下声明式的系统配置管理。
这次算是一次调研，一直想清理下乱乱的软件配置。
如果NixOS不能统一管理大多数配置文件的话，我再继续清理使用archlinux。



## 特性



### NixOS

NixOS是GNU/Linux发行版，旨在改善系统配置管理的最新水平。

在现有发行版中，升级之类的操作很危险：

- 升级软件包可能会导致其他软件包损坏
- 升级整个系统的可靠性要比从头开始重新安装低得多
- 无法安全地测试配置更改的结果

由此，NixOS提供了一些创新的功能。



#### 声明式系统配置模型

在NixOS中，**整个操作系统**(内核、应用程序、系统包、配置文件等等)都是**由Nix包管理器**根据纯函数式构建语言的描述构建的。

它是纯函数式的，这一事实本质上意味着构建**新配置不会覆盖旧配置**。其他大多数特性都是基于此。



**可重现的系统配置**

- 通过NixOS的声明性配置模型，可以轻松地在另一台机器上重现系统配置（例如，在生产服务器上进行测试之前先测试测试环境中的更改）。  
- 您只需将`configuration.nix`文件复制到目标NixOS计算机并运行`nixos-rebuild switch`。 除了“可变状态”（例如/  var中的内容）之外，这将为您提供相同的配置（内核，应用程序，系统服务等）。



#### 可靠的升级

纯函数式包管理的另一个优点是，无论您的系统上已经有什么包或配置文件，系统构建总是会产生相同的结果。

因此，升级系统和从头重新安装系统一样可靠。



**原子式升级**

- NixOS具有配置管理的事务性方法，即**配置更改是原子性的**。

- 这意味着，如果升级到新配置的过程中断了，比如电源中断了一半，**系统仍将处于一致状态**：它要么启动旧配置，要么启动新配置。在大多数其他系统中，您将最终处于不一致的状态，您的机器甚至可能不再启动。



**回退**

- 由于新配置的文件不会覆盖旧的文件，因此您可以回滚到以前的配置。 
- 实际上，所有旧系统配置都会自动显示在Grub引导菜单中。 因此，如果新配置崩溃或无法正常引导，则可以通过在Grub引导菜单中选择较旧的配置来进行回滚。 
- **回滚速度非常快**：它不涉及必须从副本中还原许多文件。



**安全地测试更改**

- 可以通过`nixos-rebuild test`来构建并激活新的配置，但不会使其成为引导默认设置。因此，重新启动系统将带您回到以前的、已知的良好配置。
- 更好的方法是构建并启动一个虚拟机。VM不与主机共享任何数据，因此您可以在VM内进行安全实验。



#### 包管理特性



**带有二进制文件的基于源码模型**

- NixOS使用的Nix构建语言指定了如何从源代码构建软件包。

- 这样可以轻松调整系统，只需在`/etc/nixos`中为NixOS或Nixpkgs编辑任何Nix表达式，然后运行nixos-rebuild。

- 但是，从源码构建也很慢。因此，如果可用，Nix会自动从nixos.org下载**预编译的二进制文件**。 这为二进制模型的效率提供了基于源的包管理模型的灵活性。



**依赖一致性**

- Nix软件包管理器可确保正在运行的系统与系统的逻辑规范“一致”，这意味着它将重建所有需要重建的软件包。

- 例如，如果您更改内核，Nix将确保还重建外部内核模块（例如NVIDIA驱动程序），因此您永远不会遇到X服务器在内核安全性升级后神秘地无法启动（笑）。 并且，如果您更新OpenSSL库，Nix会确保系统中的所有软件包都使用新版本，甚至包括静态链接到OpenSSL的软件包。



**多用户包管理**

- 在NixOS上，不需要root用户即可安装软件。除了系统范围的配置文件外，所有用户都有自己的配置文件，可以在其中安装软件包。

- Nix允许软件包的**多个版本共存**，因此不同的用户可以在各自的配置文件中安装同一软件包的不同版本。

- 如果两个用户安装了相同版本的软件包，则只会生成或下载一个副本，并且Nix的安全模型可确保此安全性。 用户无法安装setuid二进制文件。



总结一下，在NixOS这个部分，我认为最棒的亮点是声明式配置管理、原子式升级、依赖一致性。



### Nix