
<!-- vim-markdown-toc GitLab -->

* [区块链技术实践 - Hyperledger Fabric 2](#区块链技术实践-hyperledger-fabric-2)
    * [简介](#简介)
    * [Fabric 架构](#fabric-架构)
    * [Fabric 核心组件](#fabric-核心组件)
        * [Network](#network)
        * [节点](#节点)
        * [共识](#共识)
        * [Ledger - 账本](#ledger-账本)
        * [Chaincode - 链码](#chaincode-链码)
    * [Fabric 交易流程](#fabric-交易流程)

<!-- vim-markdown-toc -->

# 区块链技术实践 - Hyperledger Fabric 2

> https://hyperledger-fabric.readthedocs.io/zh_CN/latest/



## 简介

Hyperledger Fabric 是 Hyperledger 中的区块链项目之一。与其他区块链技术一样，它有一个账本，使用智能合约，是一个参与者管理交易的系统。

在功能上，其不同点有：

1. 提供多种可插拔选项

   有多种账本**数据格式存储**（LevelDB、CouchDB），**共识机制**可以交换替换（SOLO开发用、Kafka、Raft），并且支持**不同的MSP**。

2. **授权**提供安全性

   与公链不同，网络的成员需要从可信赖的 **成员服务提供者（MSP）** 注册。

3. 创建**通道**保护隐私

   允许一组参与者创建各自的交易账本，只有同一个通道的参与者才能查看数据，它提供了一种竞争者间保护隐私的方法。



## Fabric 架构

> https://learnblockchain.cn/books/enterprise/chapter3_03%20hyperledger_fabric_architecture.html

Fabric分为四大模块，分别是成员服务、区块链服务、智能合约和应用编程接口。



**成员服务**

- 成员服务（MSP）主要提供证书发布、验证及相关加密机制和协议。内置了Fabric CA证书颁发机构。
- Fabric CA提供客户端和SDK两种方式与CA进行交互，每个Fabric CA都有一个根CA或者中间CA。
- 为了便于证书管理，一般使用根证书、业务证书、用户证书三级证书结构。他们的关系是上级签发下级，呈树状。
- 业务证书又包含三种互相平行的证书：身份认证证书、交易签名证书、安全通讯证书。



**区块链服务**

1. **P2P协议**
   - Fabric网络中，节点Peer和排序服务Orderer采用gRPC对外提供远程服务，供客户端进行调用。
   - 节点之间通过 Gossip 协议来进行状态同步和分发。

2. **共识机制**
   - 交易必须按照发生的顺序写入**到分布式账本中。为此必须采用一种共识机制拒绝错误（或恶意）的交易数据，保证交易的顺序。
   - Fabric允许根据实际业务需要选择合适的共识机制，目前支持SOLO、Kafka、Raft三种共识机制。

3. **分布式账本**
   - 分布式账本包括两个组件：世界状态、事务日志，分布式账本是世界状态数据库和事务日志历史记录的组合。
   - **世界状态**（world state）组件记录的是最新的分布式账本状态，**事务日志**组件记录的是世界状态的更新历史。



**智能合约服务** 

- 智能合约服务用于保证智能合约在网络节点上安全运行。

- 是一组运行在验证节点上的去中心化交易程序。
- 在Fabric中被称为链码（chaincode），由外部应用程序（比如网页、APP）与分布式账本进行交互。
- 使用Docker存放链上的代码（而不需要依靠特定的虚拟机），Docker为链码执行提供了一个安全、轻便的语言执行环境。



**应用编程接口** 

- 应用编程接口提供SDK（开发工具包）和CLI（命令行）两种方式供开发人员使用区块链的各种服务。
- 主要是对分布式账本进行查询、更新。



## Fabric 核心组件

> https://learnblockchain.cn/books/enterprise/chapter3_04%20hyperledger_fabric_core_components.html



### Network

> 在Fabric网络中，Peer和Orderer采用gRPC对外提供远程服务，供客户端进行调用。
>
> 节点之间通过Gossip 协议来进行状态同步和分发。 

Gossip 协议是P2P 领域的常见协议，用于进行网络内多个节点之间的数据分发或信息交换。由于其设计简单，容易实现，同时容错性比较高，而被广泛应用到了许多分布式系。

Gossip  协议的基本思想十分简单，数据发送方从网络中随机选取若干节点，将数据发送过去，接收方重复这一过程（往往只选择发送方之外节点进行传播）。这一过程持续下去，网络中所有节点最终（时间复杂度为节点总个数的对数）都会达到一致。数据传输的方向可以是发送方发送或获取方拉取。



### 节点

> [PKI/CA工作原理及架构](https://www.jianshu.com/p/c65fa3af1c01)

**服务节点类型**

​	对网络中节点角色进行解耦是Fabric 设计中的一大创新，这也是联盟链场景下的特殊需求和环境所决定。

- **背书节点**（ Endorser ）

  负责对交易的<u>提案</u>（ proposal ）进行验证并模拟交易执行；

- **提交节点**（ Committer ）

  负责在接受交易结果前再次检查合法性，接受合法交易对账本的修改，并写入区块链结构；

- **排序节点**（ Orderer ）

  对所有发往网络中的交易进行排序，将排序后的交易按照配置中的约定整理为区块，之后提交给确认节点进行处理；

- **证书节点**（ CA ）

  负责对网络中所有的证书进行管理，提供标准的**PKI服务**。



注意：

1. 除了用户节点，网络所有的全节点都具备Commiter功能，部分节点具有Endorser、Orderer功能。
2. **锚节点**是一种外部可发现的节点，配置了对外服务的端口。可以被Orderer节点和其它任何节点发现。
3. 证书节点是一个相对独立证书管理机构，也可以由第三方证书机构来承担这个角色。



### 共识

广义的共识机制包含背书、排序和验证三个环节，狭义的共识指的是排序。



**背书**

- 就是相关组织对交易的认可，在Fabric中是相关节点对交易进行签名。
- 交易验证由网络中业务相关方进行。
- 对于一个链码交易来说，背书策略是在链码实例化的时候指定的；一笔有效交易必须是背书策略相关组织签名后才能生效。



**排序服务**

- 通常由排序节点来提供，用来对全网交易达成一致顺序。
- 排序服务只负责对交易顺序达成一致，这就有效避免了整个网络瓶颈，而且排序节点也很容易横向扩展，以提高整个网络的效率。
- 排序服务目前支持Kafka（v2弃用）和Raft（非拜占庭的共识机制）两种，可插拔架构也允许根据业务需要设计符合拜占庭的共识机制（如实用拜占庭）。



**验证**

- 是对排序后的交易提交到账本之前最终的检查。
- 检查的内容包含交易**结构的合法性**、**交易背书签名**是否符合背书策略等



### Ledger - 账本

区块是一组排序后的交易集合，将区块通过密码算法连接起来就是区块链。

在Fabric中交易可以存储相关业务信息。

账本包含状态数据库和历史数据库：

1. 状态数据库记录的是变更记录的最新结果，方便查询，使用CouchDB；
2. 历史数据库记录的是区块链结构，使用LevelDB。



### Chaincode - 链码

智能合约在Fabric中也被称为链码（chaincode）。



**用户链码和系统链码**

​	目前超级账本Fabric 项目中提供了用户链码和系统链码。

1. **用户链码**

   - 运行在单独的容器中，提供对上层应用的支持。
   - 一般所谈的链码为用户链码，用户通过链码相关的API 编写用户链码，即可对账本中状态进行更新操作。

2. **系统链码**则嵌入在系统内，提供对系统进行配置、管理的支持。

   - 系统链码有以下五个合约：

     - Configuration System Chaincode (CSCC)

       管理peer上通道相关的信息以及执行通道配置交易。

     - Life Cycle System Chaincode (LSCC) 

       用于管理链码的生命周期——在peer上安装链码、在通道上实例化和升级链码、用户从运行中的链码获取信息。

     - Query System Chaincode (QSCC) 

       运行在所有Peer上，提供账区块查询、交易查询等API。

     - Endorser System Chaincode (ESCC) 

       由背书节点调用，对一个交易响应进行密码签名。

     - Validator System Chaincode (VSCC) 

       由<u>记账节点</u>调用，包括检查背书策略和读写集版本。



**链码**

- 经过安装和实例化操作后，即可被调用。
  - 安装时，需要指定具体安装到哪个Peer 节点；
  - 实例化时，需要指定通道内及背书策略。
- Fabric 目前主要支持基于Go 语言、Java、Node.js。



## Fabric 交易流程

> https://learnblockchain.cn/books/enterprise/chapter3_05%20hyperledger_fabric_workflow_of_transaction.html

一个完整的交易要涉及应用程序、证书服务、背书节点、提交节点和排序节点。

- 应用程序（App）：调用Fabric SDK与区块链网络进行交互，这里的应用程序可以是网页，也可以是APP；



客户端使用SDK与Fabric网络进行交互：

1. 客户端先通过证书服务**获取合法的身份**并**加入到应用通道**（Channel）中。
2. 客户端构造**交易请求**（Proposal）提交给背书节点（Endorser）。
3. 背书节点对交易进行**验证和模拟**执行后（并不真正更新账本），反馈给客户端。
4. 客户端收到**足够的背书支持**后将交易发送给Orderer节点。
5. Orderer节点对网络中的交易进行**全局排序**，并将排序后的**交易打包成区块**，然后**广播**给网络中的提交节点。
6. 提交节点负责**维护区块链和账本结构**，对**交易进行最终检查**（交易结构的合法性、交易背书签名是否符合背书策略等），检查通过后写入账本。



